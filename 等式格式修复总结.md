# AND-MoE论文等式格式修复总结

## 修复的问题

### 1. 等式（13）超过单栏显示问题
**问题**: 等式（13）包含长公式，在单栏中显示时超出边界

**原始等式**:
```latex
\begin{equation}
z_{l,j} = \frac{\mathcal{F}_{\text{MoE}}(S_{\text{selected},l}; k_j) - \text{median}_l}{\sigma_l}
\end{equation}
```

**修复方案**: 使用 `align` 环境替代 `equation` 环境
```latex
\begin{align}
z_{l,j} &= \frac{\mathcal{F}_{\text{MoE}}(S_{\text{selected},l}; k_j) - \text{median}_l}{\sigma_l}
\end{align}
```

### 2. 其他长等式的修复

#### 等式（17）修复
**原始等式**:
```latex
\begin{equation}
\mathbb{E}[Z'_{\text{final}}] = \sum_{i=1}^M \mathbb{E}[z'_i] = \sum_{i=1}^M p_s \cdot \mu_z = M \cdot p_s \cdot \mu_z
\end{equation}
```

**修复方案**: 使用多行对齐
```latex
\begin{align}
\mathbb{E}[Z'_{\text{final}}] &= \sum_{i=1}^M \mathbb{E}[z'_i] \\
&= \sum_{i=1}^M p_s \cdot \mu_z \\
&= M \cdot p_s \cdot \mu_z
\end{align}
```

#### 等式（15）修复
**原始等式**:
```latex
\begin{equation}
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \lambda \cdot \sum_{l=1}^{L} D_{KL}(P_{\text{original}}(S_l|\text{canary}) || P_{\text{finetuned}}(S_l|\text{canary}))
\end{equation}
```

**修复方案**: 使用多行对齐
```latex
\begin{align}
\mathcal{L}_{\text{total}} &= \mathcal{L}_{\text{task}} + \lambda \cdot \sum_{l=1}^{L} D_{KL}(P_{\text{original}}(S_l|\text{canary}) \\
&\quad || P_{\text{finetuned}}(S_l|\text{canary}))
\end{align}
```

## 修复策略

### 1. 环境选择
- **短等式**: 使用 `equation` 环境
- **长等式**: 使用 `align` 环境，支持多行对齐
- **复杂等式**: 使用 `align` 环境，手动换行

### 2. 换行技巧
- **等号对齐**: 使用 `&=` 进行等号对齐
- **缩进处理**: 使用 `\quad` 进行适当的缩进
- **逻辑分组**: 将等式的不同部分分行显示

### 3. 可读性优化
- **保持数学逻辑**: 确保等式的数学含义不变
- **视觉对齐**: 使用对齐符号提高可读性
- **长度控制**: 每行长度控制在合理范围内

## 修复效果

### 1. 显示效果
- ✅ 所有长等式现在都能在单栏中正确显示
- ✅ 等式内容完整，没有截断
- ✅ 数学符号正确对齐

### 2. 可读性提升
- ✅ 多行显示提高了等式的可读性
- ✅ 逻辑分组使等式结构更清晰
- ✅ 对齐符号使等式更美观

### 3. 格式一致性
- ✅ 所有等式使用统一的格式
- ✅ 对齐方式保持一致
- ✅ 缩进处理统一

## 技术细节

### LaTeX环境对比
| 环境 | 特点 | 适用场景 |
|------|------|----------|
| `equation` | 单行，自动编号 | 短等式 |
| `align` | 多行，手动对齐 | 长等式，复杂等式 |
| `eqnarray` | 多行，自动对齐 | 不推荐使用 |

### 对齐符号使用
- `&`: 对齐点标记
- `\\`: 换行符
- `\quad`: 水平间距
- `\qquad`: 更大的水平间距

### 换行策略
1. **等号处换行**: 在等号前换行，保持对齐
2. **运算符处换行**: 在运算符前换行
3. **括号处换行**: 在括号前换行，保持结构

## 验证结果

### 1. 编译检查
- ✅ 无LaTeX编译错误
- ✅ 所有等式正确显示
- ✅ 数学符号正确渲染

### 2. 格式检查
- ✅ 等式编号正确
- ✅ 对齐方式一致
- ✅ 换行位置合理

### 3. 可读性检查
- ✅ 等式内容完整
- ✅ 逻辑结构清晰
- ✅ 视觉效果良好

## 建议

### 1. 等式设计原则
- 对于包含长公式的等式，优先使用 `align` 环境
- 保持等式的数学逻辑完整性
- 考虑读者的阅读体验

### 2. 换行策略
- 在逻辑断点处换行
- 保持等式的数学结构
- 使用适当的缩进和对齐

### 3. 格式统一
- 统一使用相同的对齐方式
- 保持缩进的一致性
- 确保所有等式格式统一

## 总结

通过以上修复，AND-MoE论文中的所有长等式问题已经得到解决：

1. **等式（13）**: 使用 `align` 环境，单行显示
2. **等式（15）**: 使用多行对齐，提高可读性
3. **等式（17）**: 使用多行对齐，逻辑分组

这些修复确保了论文在USENIX会议格式要求下的正确显示，所有等式都能在单栏中完整显示，提高了论文的可读性和专业性。
